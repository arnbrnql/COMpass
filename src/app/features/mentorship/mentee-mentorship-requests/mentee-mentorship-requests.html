@let vm = viewModel$ | async;

@if (vm) {
<div class="container mx-auto p-4 md:p-8">
  <div class="mb-8">
    <h1 class="text-3xl font-bold">My Mentorship Requests</h1>
    <p class="mt-2 text-base-content/70">Track your mentorship requests</p>
  </div>

  <div class="tabs tabs-boxed mb-6 flex-wrap">
    <button
      class="tab"
      [class.tab-active]="vm.selectedStatus === 'all'"
      (click)="setStatusFilter('all')"
    >
      All ({{ vm.requestCounts.all }})
    </button>
    <button
      class="tab"
      [class.tab-active]="vm.selectedStatus === RequestStatus.Pending"
      (click)="setStatusFilter(RequestStatus.Pending)"
    >
      Pending ({{ vm.requestCounts.pending }})
    </button>
    <button
      class="tab"
      [class.tab-active]="vm.selectedStatus === RequestStatus.Approved"
      (click)="setStatusFilter(RequestStatus.Approved)"
    >
      Approved ({{ vm.requestCounts.approved }})
    </button>
    <button
      class="tab"
      [class.tab-active]="vm.selectedStatus === RequestStatus.Rejected"
      (click)="setStatusFilter(RequestStatus.Rejected)"
    >
      Rejected ({{ vm.requestCounts.rejected }})
    </button>
    <button
      class="tab"
      [class.tab-active]="vm.selectedStatus === RequestStatus.Done"
      (click)="setStatusFilter(RequestStatus.Done)"
    >
      Completed ({{ vm.requestCounts.done }})
    </button>
  </div>

  @if (vm.error; as errorMessage) {
    <app-error-state
      class="mb-8"
      title="Unable to load requests"
      [message]="errorMessage"
      [showRetry]="true"
      retryLabel="Retry"
      (retry)="retryLoad()"
    />
  } @else if (vm.loading) {
    <app-loading-state
      class="mb-8"
      title="Loading mentorship requests"
      message="We're retrieving the latest updates from your mentors."
      [showBackdrop]="true"
    />
  } @else {
    @if (vm.filteredRequests.length === 0) {
      <div class="flex items-center justify-center min-h-[400px]">
        @if (vm.requests.length === 0) {
          <app-empty-state
            iconName="calendar"
            title="No requests found"
            message="You haven't made any mentorship requests yet. Start by browsing mentors who can help you grow."
            actionLabel="Discover mentors"
            (action)="goToMentorDirectory()"
          />
        } @else {
          <app-empty-state
            iconName="inbox"
            title="No requests in this category"
            [message]="getEmptyFilterMessage(vm.selectedStatus)"
            actionLabel="View all requests"
            (action)="setStatusFilter('all')"
          />
        }
      </div>
    } @else {
      <div class="space-y-6">
        @for (request of vm.filteredRequests; track request.requestId) {
          @let requestItem = vm.itemByRequestId.get(request.requestId);
          @let mentorItem = requestItem ? vm.itemByMentorId.get(request.mentorId) : null;
          @let mentor = mentorItem?.mentor;
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body space-y-4">
              <div class="flex flex-col justify-between gap-4 md:flex-row md:items-start">
                <div class="flex flex-1 items-center gap-4">
                  <div class="avatar">
                    <div class="w-12 rounded-full ring ring-primary ring-offset-2 ring-offset-base-100">
                      @if (mentor) {
                        <img
                          [src]="mentor?.photoURL?.trim() || getInitialsAvatar(mentor?.displayName, { size: 48 })"
                          [alt]="(mentor?.displayName || 'Mentor') + ' avatar'"
                          width="48"
                          height="48"
                        />
                      } @else {
                        <div class="flex h-full w-full items-center justify-center bg-base-300">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                          </svg>
                        </div>
                      }
                    </div>
                  </div>
                  <div class="min-w-0 flex-1">
                    @if (mentor) {
                      <h3 class="truncate text-lg font-semibold">{{ mentor?.displayName || 'Unknown mentor' }}</h3>
                      <p class="text-sm text-base-content/70">{{ mentor?.email || 'No email' }}</p>
                    } @else {
                      <h3 class="text-lg font-semibold">Loading mentor...</h3>
                      <p class="text-sm text-base-content/70">{{ request.createdAt | timeAgo }}</p>
                    }
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="badge" [class]="getStatusBadgeClass(request.status)">
                    {{ request.status | titlecase }}
                  </div>
                </div>
              </div>

              <div class="space-y-4">
                <p class="text-sm text-base-content/60">Requested {{ request.createdAt | timeAgo }}</p>

                <div>
                  <h4 class="font-semibold mb-2">Your Message</h4>
                  <p class="rounded-lg bg-base-200 p-3 text-base-content/80">
                    {{ request.message }}
                  </p>
                </div>
              </div>

              @if (request.goals.length) {
                <div>
                  <h4 class="font-semibold mb-2">Goals</h4>
                  <div class="flex flex-wrap gap-2">
                    @for (goal of request.goals; track goal) {
                      <span class="badge badge-outline">{{ goal }}</span>
                    }
                  </div>
                </div>
              }

              <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                <div>
                  <h4 class="font-semibold mb-1">Experience Level</h4>
                  <p class="text-base-content/80 capitalize">{{ request.experienceLevel }}</p>
                </div>
                <div>
                  <h4 class="font-semibold mb-1">Meeting Frequency</h4>
                  <p class="text-base-content/80 capitalize">{{ request.preferredMeetingFrequency }}</p>
                </div>
              </div>

              @if (request.status === RequestStatus.Pending) {
                <div class="alert alert-info">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    <h4 class="font-semibold">Request Pending</h4>
                    <p>Your mentorship request is waiting for the mentor's response.</p>
                  </div>
                </div>
              }

              @if (request.status === RequestStatus.Approved) {
                <div class="alert alert-success">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div class="flex-1">
                    <h4 class="font-semibold">Request Approved!</h4>
                    @if (requestItem?.schedule?.isCalendarUnlocked()) {
                      <p>You can now book sessions with this mentor through their Cal.com calendar.</p>
                      @if (mentorItem ? vm.calendarByMentorId.get(request.mentorId) : null; as calendarLink) {
                        <div class="mt-4 space-y-4">
                          <div class="flex flex-wrap items-center gap-3">
                            <a
                              class="btn btn-success btn-sm"
                              [href]="calendarLink.raw"
                              target="_blank"
                              rel="noopener"
                            >
                              Open in Cal.com
                            </a>
                            <span class="text-sm text-base-content/70">Bookings open while the mentorship is active.</span>
                          </div>
                          <div class="overflow-hidden rounded-lg border border-success/20">
                            @if (calendarLink.safe; as safeUrl) {
                              <iframe
                                [src]="safeUrl"
                                class="h-[600px] w-full"
                                frameborder="0"
                                title="Cal.com calendar"
                              ></iframe>
                            }
                          </div>
                        </div>
                      } @else {
                        <div class="alert alert-warning mt-4">
                          <p>This mentor hasn't published their Cal.com link yet. Reach out to coordinate your session.</p>
                        </div>
                      }
                    } @else {
                      <p>Your mentor will unlock their calendar once your first session is scheduled.</p>
                    }
                  </div>
                </div>
              }

              @if (request.status === RequestStatus.Rejected) {
                <div class="alert alert-error">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    <h4 class="font-semibold">Request Rejected</h4>
                    <p>The mentor wasn't able to take on this mentorship. Explore other mentors who can help.</p>
                  </div>
                </div>
              }

              @if (request.status === RequestStatus.Done) {
                <div class="alert alert-info">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    <h4 class="font-semibold">Mentorship Completed!</h4>
                    <p>This mentorship has been marked as completed.</p>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  }
</div>
}
